@{
    Trip trip = ViewBag.Trip;
    IEnumerable<PackingListItem> packingListItems = ViewBag.PackingListItems;
    IEnumerable<PackingListItem> packingListItemsNoTag = packingListItems.Where(pli => pli.ItemTag.Tag == null);
    IEnumerable<Tag> tags = ViewBag.Tags;
    ViewBag.Title = trip.Name + " - Packing List";
    ViewBag.ShowInSiteMap = @trip.ShowInSearch;
    User currentUser = ViewBag.CurrentUser;
}
<header>
    <h2>
        Packing List
        @if (currentUser.DefaultTrip == trip)
        {
            <span><a href="@Url.PackingListIndex()">Search Items</a></span>
        }
    </h2>
</header>
@if (packingListItems.Any())
{
    <div class="packing-list-tags fluid">
        @if (packingListItemsNoTag.Any())
        {
            <div class="packing-list-tag">
                <h3>
                    General Items</h3>
                @ItemList(packingListItemsNoTag)
            </div>
        }
        @if (tags.Any())
        {
            foreach (var tag in tags)
            {
            <div class="packing-list-tag">
                <h3>
                    <a href="@Url.Details(tag)">@tag.NiceName</a>
                </h3>
                @ItemList(packingListItems.Where(pli => pli.ItemTag.Tag == tag))
            </div>
            }
        }
    </div>
}
else
{
    <p>
        No packing list items found.
    </p>
}
@helper ItemList(IEnumerable<PackingListItem> plis)
    {
    <ul class="packing-list-items">
        @foreach (PackingListItem pli in plis.OrderBy(pli => pli.ItemTag.Item.Name))
        {
            <li class="packing-list-item @pli.Visibility.GetClassName() @(ViewBag.UserOwnsTrip ? "owned" : string.Empty)" data-id="@pli.Id" title="Click to edit"><span class="name">@pli.ItemTag.Item.Name</span>
                @if (!string.IsNullOrEmpty(pli.Note))
                {
                    <div class="packing-list-item-note">@pli.Note</div>
                }
            </li>         
        }
    </ul>
}