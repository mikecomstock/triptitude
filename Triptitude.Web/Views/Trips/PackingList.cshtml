@{
    Trip trip = ViewBag.Trip;
    IEnumerable<PackingListItem> packingListItems = ViewBag.PackingListItems;
    IEnumerable<PackingListItem> packingListItemsNoTag = packingListItems.Where(pli => pli.ItemTag.Tag == null);
    //IEnumerable<Place> places = ViewBag.Places;
    IEnumerable<Tag> tags = ViewBag.Tags;
    ViewBag.Title = trip.Name + " - Packing List";
    ViewBag.ShowInSiteMap = @trip.ShowInSiteMap;
    User currentUser = ViewBag.CurrentUser;
}
@Html.Action("SidePanel", "Trips", new { Trip = trip })
<div id="main-container">
    <div class="panel">
        <div class="panel-title">
            <h1>
                @ViewBag.Title
            </h1>
        </div>
        @if (currentUser.DefaultTrip == trip)
        {
            <div class="subtitle">
                Use the <strong>+Add Plans</strong> menu to add items to your packing list.
            </div>
        }
        <div class="panel-content">
            @if (packingListItems.Any())
            {
                if (packingListItemsNoTag.Any())
                {
                <div class="packing-list-tag">
                    @if (tags.Any())
                    {
                        <h2>
                            General Items</h2>
                    }
                    @ItemList(packingListItemsNoTag)
                </div>
                }

                if (tags.Any())
                {
                    foreach (var tag in tags)
                    {
                <div class="packing-list-tag">
                    <h2>
                        <a href="@Url.Details(tag)">@tag.NiceName</a>
                    </h2>
                    @ItemList(packingListItems.Where(pli => pli.ItemTag.Tag == tag))
                </div>
                    }
                }
            }
            else
            {
                <p>
                    No items found.
                </p>
            }
        </div>
    </div>
</div>
@helper ItemList(IEnumerable<PackingListItem> plis)
    {
    <ul class="packing-list-items">
        @foreach (PackingListItem pli in plis.OrderBy(pli => pli.ItemTag.Item.Name))
        {
            <li class="packing-list-item @pli.Visibility.GetClassName() @(ViewBag.UserOwnsTrip ? "owned" : string.Empty)" data-id="@pli.Id">
                <span class="name">
                    @pli.ItemTag.Item.Name
                    @if (pli.Place != null)
                    {
                        <span class="packing-list-item-place" >for <a href="@Url.Details(pli.Place)">@pli.Place.Name</a> </span>
                    }
                </span>
                @if (!string.IsNullOrEmpty(pli.Note))
                {
                    <div class="packing-list-item-note">@pli.Note</div>
                }
            </li>         
        }
    </ul>
}